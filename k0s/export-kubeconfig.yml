---
- name: Export k0s kubeconfig to local machine
  hosts: k0s_nodes
  become: yes
  gather_facts: no

  tasks:
    - name: Generate kubeconfig
      command: /usr/local/bin/k0s kubeconfig admin
      register: kubeconfig_content
      changed_when: false

    - name: Save kubeconfig to local machine
      local_action:
        module: copy
        content: "{{ kubeconfig_content.stdout }}"
        dest: "{{ lookup('env', 'HOME') }}/.kube/k0s-config"
        mode: "0600"

    - name: Display success message
      debug:
        msg: |
          ============================================
          Kubeconfig exported successfully!
          ============================================

          Location: {{ lookup('env', 'HOME') }}/.kube/k0s-config

          To use it:

          Option 1 - Export environment variable:
          export KUBECONFIG=~/.kube/k0s-config
          kubectl get nodes

          Option 2 - Merge with existing config:
          KUBECONFIG=~/.kube/config:~/.kube/k0s-config kubectl config view --flatten > ~/.kube/merged-config
          mv ~/.kube/merged-config ~/.kube/config

          Option 3 - Use --kubeconfig flag:
          kubectl --kubeconfig ~/.kube/k0s-config get nodes

          ============================================
      delegate_to: localhost
